name: CI
on:
  push:
  pull_request:

jobs:
  backend-unit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'
      - name: Unit tests
        run: make unit

  backend-it:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        ports: ['5432:5432']
        env:
          POSTGRES_DB: efatura
          POSTGRES_USER: efatura
          POSTGRES_PASSWORD: efatura
      rabbitmq:
        image: rabbitmq:3.13-management
        ports: ['5672:5672']
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'
      - name: Integration tests
        run: make it

  frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      - name: Install
        run: cd frontend && npm ci
      - name: Unit tests
        run: cd frontend && npm run test
      - name: Install Playwright (browsers + system deps)
        run: cd frontend && npx playwright install --with-deps chromium
      - name: E2E tests
        run: cd frontend && npm run e2e

