databaseChangeLog:
  - changeSet:
      id: 001-create-core-tables
      author: efaturaai
      changes:
        - createTable:
            tableName: tenants
            columns:
              - column: { name: id, type: UUID, constraints: { primaryKey: true, nullable: false } }
              - column: { name: code, type: "VARCHAR(64)", constraints: { nullable: false, unique: true } }
              - column: { name: name, type: "VARCHAR(255)", constraints: { nullable: false } }
              - column: { name: created_at, type: "TIMESTAMP WITH TIME ZONE", defaultValueComputed: CURRENT_TIMESTAMP, constraints: { nullable: false } }
              - column: { name: updated_at, type: "TIMESTAMP WITH TIME ZONE" }

        - createTable:
            tableName: roles
            columns:
              - column: { name: id, type: UUID, constraints: { primaryKey: true, nullable: false } }
              - column: { name: tenant_id, type: UUID, constraints: { nullable: false } }
              - column: { name: name, type: "VARCHAR(100)", constraints: { nullable: false } }
              - column: { name: created_at, type: "TIMESTAMP WITH TIME ZONE", defaultValueComputed: CURRENT_TIMESTAMP, constraints: { nullable: false } }
              - column: { name: updated_at, type: "TIMESTAMP WITH TIME ZONE" }

        - addForeignKeyConstraint:
            baseTableName: roles
            baseColumnNames: tenant_id
            constraintName: fk_roles_tenant
            referencedTableName: tenants
            referencedColumnNames: id
            onDelete: CASCADE

        - addUniqueConstraint:
            tableName: roles
            columnNames: tenant_id, name
            constraintName: uq_roles_tenant_name

        - createTable:
            tableName: permissions
            columns:
              - column: { name: id, type: UUID, constraints: { primaryKey: true, nullable: false } }
              - column: { name: tenant_id, type: UUID, constraints: { nullable: false } }
              - column: { name: code, type: "VARCHAR(150)", constraints: { nullable: false } }
              - column: { name: description, type: "VARCHAR(255)" }
              - column: { name: created_at, type: "TIMESTAMP WITH TIME ZONE", defaultValueComputed: CURRENT_TIMESTAMP, constraints: { nullable: false } }
              - column: { name: updated_at, type: "TIMESTAMP WITH TIME ZONE" }

        - addForeignKeyConstraint:
            baseTableName: permissions
            baseColumnNames: tenant_id
            constraintName: fk_permissions_tenant
            referencedTableName: tenants
            referencedColumnNames: id
            onDelete: CASCADE

        - addUniqueConstraint:
            tableName: permissions
            columnNames: tenant_id, code
            constraintName: uq_permissions_tenant_code

        - createTable:
            tableName: users
            columns:
              - column: { name: id, type: UUID, constraints: { primaryKey: true, nullable: false } }
              - column: { name: tenant_id, type: UUID, constraints: { nullable: false } }
              - column: { name: username, type: "VARCHAR(100)", constraints: { nullable: false } }
              - column: { name: email, type: "VARCHAR(255)" }
              - column: { name: password_hash, type: "VARCHAR(255)", constraints: { nullable: false } }
              - column: { name: enabled, type: BOOLEAN, defaultValueBoolean: true, constraints: { nullable: false } }
              - column: { name: created_at, type: "TIMESTAMP WITH TIME ZONE", defaultValueComputed: CURRENT_TIMESTAMP, constraints: { nullable: false } }
              - column: { name: updated_at, type: "TIMESTAMP WITH TIME ZONE" }

        - addForeignKeyConstraint:
            baseTableName: users
            baseColumnNames: tenant_id
            constraintName: fk_users_tenant
            referencedTableName: tenants
            referencedColumnNames: id
            onDelete: CASCADE

        - addUniqueConstraint:
            tableName: users
            columnNames: tenant_id, username
            constraintName: uq_users_tenant_username

        - createTable:
            tableName: user_roles
            columns:
              - column: { name: user_id, type: UUID, constraints: { nullable: false } }
              - column: { name: role_id, type: UUID, constraints: { nullable: false } }
            remarks: user-role join table

        - addPrimaryKey:
            tableName: user_roles
            columnNames: user_id, role_id
            constraintName: pk_user_roles

        - addForeignKeyConstraint:
            baseTableName: user_roles
            baseColumnNames: user_id
            constraintName: fk_user_roles_user
            referencedTableName: users
            referencedColumnNames: id
            onDelete: CASCADE

        - addForeignKeyConstraint:
            baseTableName: user_roles
            baseColumnNames: role_id
            constraintName: fk_user_roles_role
            referencedTableName: roles
            referencedColumnNames: id
            onDelete: CASCADE

        - createTable:
            tableName: role_permissions
            columns:
              - column: { name: role_id, type: UUID, constraints: { nullable: false } }
              - column: { name: permission_id, type: UUID, constraints: { nullable: false } }

        - addPrimaryKey:
            tableName: role_permissions
            columnNames: role_id, permission_id
            constraintName: pk_role_permissions

        - addForeignKeyConstraint:
            baseTableName: role_permissions
            baseColumnNames: role_id
            constraintName: fk_role_permissions_role
            referencedTableName: roles
            referencedColumnNames: id
            onDelete: CASCADE

        - addForeignKeyConstraint:
            baseTableName: role_permissions
            baseColumnNames: permission_id
            constraintName: fk_role_permissions_permission
            referencedTableName: permissions
            referencedColumnNames: id
            onDelete: CASCADE

        - createTable:
            tableName: customers
            columns:
              - column: { name: id, type: UUID, constraints: { primaryKey: true, nullable: false } }
              - column: { name: tenant_id, type: UUID, constraints: { nullable: false } }
              - column: { name: tax_number, type: "VARCHAR(32)" }
              - column: { name: name, type: "VARCHAR(255)", constraints: { nullable: false } }
              - column: { name: email, type: "VARCHAR(255)" }
              - column: { name: address, type: "VARCHAR(1024)" }
              - column: { name: created_at, type: "TIMESTAMP WITH TIME ZONE", defaultValueComputed: CURRENT_TIMESTAMP, constraints: { nullable: false } }
              - column: { name: updated_at, type: "TIMESTAMP WITH TIME ZONE" }

        - addForeignKeyConstraint:
            baseTableName: customers
            baseColumnNames: tenant_id
            constraintName: fk_customers_tenant
            referencedTableName: tenants
            referencedColumnNames: id
            onDelete: CASCADE

        - addUniqueConstraint:
            tableName: customers
            columnNames: tenant_id, tax_number
            constraintName: uq_customers_tenant_tax
            validate: true

        - createTable:
            tableName: items
            columns:
              - column: { name: id, type: UUID, constraints: { primaryKey: true, nullable: false } }
              - column: { name: tenant_id, type: UUID, constraints: { nullable: false } }
              - column: { name: sku, type: "VARCHAR(64)", constraints: { nullable: false } }
              - column: { name: name, type: "VARCHAR(255)", constraints: { nullable: false } }
              - column: { name: unit_price, type: "DECIMAL(18,2)", constraints: { nullable: false } }
              - column: { name: vat_rate, type: "DECIMAL(5,2)", constraints: { nullable: false, defaultValueNumeric: 20 } }
              - column: { name: created_at, type: "TIMESTAMP WITH TIME ZONE", defaultValueComputed: CURRENT_TIMESTAMP, constraints: { nullable: false } }
              - column: { name: updated_at, type: "TIMESTAMP WITH TIME ZONE" }

        - addForeignKeyConstraint:
            baseTableName: items
            baseColumnNames: tenant_id
            constraintName: fk_items_tenant
            referencedTableName: tenants
            referencedColumnNames: id
            onDelete: CASCADE

        - addUniqueConstraint:
            tableName: items
            columnNames: tenant_id, sku
            constraintName: uq_items_tenant_sku

        - createTable:
            tableName: invoices
            columns:
              - column: { name: id, type: UUID, constraints: { primaryKey: true, nullable: false } }
              - column: { name: tenant_id, type: UUID, constraints: { nullable: false } }
              - column: { name: invoice_no, type: "VARCHAR(64)", constraints: { nullable: false } }
              - column: { name: customer_id, type: UUID, constraints: { nullable: false } }
              - column: { name: issue_date, type: "DATE", constraints: { nullable: false } }
              - column: { name: currency, type: "VARCHAR(3)", defaultValue: 'TRY', constraints: { nullable: false } }
              - column: { name: total_net, type: "DECIMAL(18,2)", constraints: { nullable: false } }
              - column: { name: total_vat, type: "DECIMAL(18,2)", constraints: { nullable: false } }
              - column: { name: total_gross, type: "DECIMAL(18,2)", constraints: { nullable: false } }
              - column: { name: status, type: "VARCHAR(32)", constraints: { nullable: false } }
              - column: { name: created_at, type: "TIMESTAMP WITH TIME ZONE", defaultValueComputed: CURRENT_TIMESTAMP, constraints: { nullable: false } }
              - column: { name: updated_at, type: "TIMESTAMP WITH TIME ZONE" }

        - addForeignKeyConstraint:
            baseTableName: invoices
            baseColumnNames: tenant_id
            constraintName: fk_invoices_tenant
            referencedTableName: tenants
            referencedColumnNames: id
            onDelete: CASCADE

        - addForeignKeyConstraint:
            baseTableName: invoices
            baseColumnNames: customer_id
            constraintName: fk_invoices_customer
            referencedTableName: customers
            referencedColumnNames: id
            onDelete: RESTRICT

        - addUniqueConstraint:
            tableName: invoices
            columnNames: tenant_id, invoice_no
            constraintName: uq_invoices_tenant_no

        - createTable:
            tableName: invoice_lines
            columns:
              - column: { name: id, type: UUID, constraints: { primaryKey: true, nullable: false } }
              - column: { name: tenant_id, type: UUID, constraints: { nullable: false } }
              - column: { name: invoice_id, type: UUID, constraints: { nullable: false } }
              - column: { name: item_id, type: UUID }
              - column: { name: description, type: "VARCHAR(512)" }
              - column: { name: quantity, type: "DECIMAL(18,4)", constraints: { nullable: false } }
              - column: { name: unit_price, type: "DECIMAL(18,4)", constraints: { nullable: false } }
              - column: { name: vat_rate, type: "DECIMAL(5,2)", constraints: { nullable: false } }
              - column: { name: line_total, type: "DECIMAL(18,2)", constraints: { nullable: false } }

        - addForeignKeyConstraint:
            baseTableName: invoice_lines
            baseColumnNames: tenant_id
            constraintName: fk_invoice_lines_tenant
            referencedTableName: tenants
            referencedColumnNames: id
            onDelete: CASCADE

        - addForeignKeyConstraint:
            baseTableName: invoice_lines
            baseColumnNames: invoice_id
            constraintName: fk_invoice_lines_invoice
            referencedTableName: invoices
            referencedColumnNames: id
            onDelete: CASCADE

        - addForeignKeyConstraint:
            baseTableName: invoice_lines
            baseColumnNames: item_id
            constraintName: fk_invoice_lines_item
            referencedTableName: items
            referencedColumnNames: id
            onDelete: SET NULL

        - createTable:
            tableName: outbox
            columns:
              - column: { name: id, type: UUID, constraints: { primaryKey: true, nullable: false } }
              - column: { name: tenant_id, type: UUID, constraints: { nullable: false } }
              - column: { name: aggregate_type, type: "VARCHAR(100)", constraints: { nullable: false } }
              - column: { name: aggregate_id, type: "VARCHAR(100)", constraints: { nullable: false } }
              - column: { name: event_type, type: "VARCHAR(150)", constraints: { nullable: false } }
              - column: { name: payload, type: JSONB, constraints: { nullable: false } }
              - column: { name: headers, type: JSONB }
              - column: { name: status, type: "VARCHAR(30)", defaultValue: 'NEW', constraints: { nullable: false } }
              - column: { name: retry_count, type: INT, defaultValueNumeric: 0, constraints: { nullable: false } }
              - column: { name: next_retry_at, type: "TIMESTAMP WITH TIME ZONE" }
              - column: { name: created_at, type: "TIMESTAMP WITH TIME ZONE", defaultValueComputed: CURRENT_TIMESTAMP, constraints: { nullable: false } }

        - addForeignKeyConstraint:
            baseTableName: outbox
            baseColumnNames: tenant_id
            constraintName: fk_outbox_tenant
            referencedTableName: tenants
            referencedColumnNames: id
            onDelete: CASCADE

        - createTable:
            tableName: audit_logs
            columns:
              - column: { name: id, type: UUID, constraints: { primaryKey: true, nullable: false } }
              - column: { name: tenant_id, type: UUID, constraints: { nullable: false } }
              - column: { name: entity_type, type: "VARCHAR(150)", constraints: { nullable: false } }
              - column: { name: entity_id, type: "VARCHAR(100)", constraints: { nullable: false } }
              - column: { name: action, type: "VARCHAR(50)", constraints: { nullable: false } }
              - column: { name: actor_user_id, type: UUID }
              - column: { name: metadata, type: JSONB }
              - column: { name: created_at, type: "TIMESTAMP WITH TIME ZONE", defaultValueComputed: CURRENT_TIMESTAMP, constraints: { nullable: false } }

        - addForeignKeyConstraint:
            baseTableName: audit_logs
            baseColumnNames: tenant_id
            constraintName: fk_audit_logs_tenant
            referencedTableName: tenants
            referencedColumnNames: id
            onDelete: CASCADE

        - createIndex:
            tableName: audit_logs
            indexName: idx_audit_logs_entity
            columns:
              - column: { name: entity_type }
              - column: { name: entity_id }


